---
title: "sim_survival"
author: "Yunqi Yang"
date: "2/1/2023"
output: html_document
---

## Description:
Simulate time-to-event data based on exponential model. And fit proportional hazard model to data. Let's first simulate data without **censoring**. 

The exponential regression (AFT: accelerated failure time):

It assumes survival time $T$ follows exponential distribution. Under this assumption, the hazard is constant over time. 
$$
\begin{split}
T&\sim \exp(\mu)\\
f(t)&=\frac{1}{\mu}\exp\{-t/\mu\}\\
\lambda(t)&=1/\mu
\end{split}
$$

Remember in exponential distribution, $E(T)=\mu$. So we model the $\log\mu$ part by linear combinations of variables. 
$$
\begin{split}
\log(T_i) &= \log(E(T_i)) + \epsilon_i\\
&=\beta_0 + X_i^T\beta+\epsilon_i
\end{split}
$$


### Simulate under 4 simple scenarios, two variables $x_1$ and $x_2$ available:

1. The null model, time $T_i$ is simulated from the model that only has intercept. 

2. Single effect model without correlation. Time $T_i$ depends on $x_1$ only, and no correlation between $x_1$ and $x_2$

3. Single effect model with correlation. Time $T_i$ depends on $x_1$ only, and high correlation between $x_1$ and $x_2$. 

4. $\log T_i = \beta_0+\beta_1x_{i1} + \beta_2x_{i2}+\epsilon_i$, and high correlation between $x_1$ and $x_2$. 


```{r}
library(mvtnorm)
library(survival)
```



```{r}
# Here we use parametric model to simulate data with survival time,
# assuming survival time is exponentially distributed. 
# We first simulate the mean of exponential from linear combinations
# of variables, and then simulate survival time. 
# T\sim 1/u*exp(-t/u), and the true model is:
# log(T) = \mu + e = b0 + Xb + e
# @param b: vector of length (p+1) for true effect size, include intercept.
# @param X: variable matrix of size n by p. 
# @param status: censoring status. 1 = censored, 2 = event observed. 
sim_dat <- function(b, X){
  n = nrow(X)
  mu <- exp(cbind(rep(1,n), X) %*% b)
  surT <- rexp(n, rate = 1/mu)
  dat <- data.frame(cbind(surT, X))
  names(dat) = c("surT", "x1", "x2")
  dat$status <- rep(2, n)
  return(dat)
}
```

#### Scenario 1: null model
```{r}
set.seed(1)
n <- 50
b <- c(1, 0, 0)
X <- rmvnorm(n, sigma = matrix(c(1, 0.5, 0.5, 1), ncol = 2, nrow = 2))
dat1 <- sim_dat(b, X)
```

```{r}
hist(dat1$surT, breaks = 20)
```


#### Scenario 2: single effect model with independent predictors
```{r}
set.seed(1)
n <- 50
b <- c(1, 3, 0)
X <- rmvnorm(n, sigma = matrix(c(1, 0, 0, 1), ncol = 2, nrow = 2))
dat2 <- sim_dat(b, X)
```

```{r}
hist(dat2$surT, breaks = 20)
```


#### Scenario 3: single effect model with independent predictors
```{r}
set.seed(1)
n <- 50
b <- c(1, 3, 0)
X <- rmvnorm(n, sigma = matrix(c(1, 0.9, 0.9, 1), ncol = 2, nrow = 2))
dat3 <- sim_dat(b, X)
```

```{r}
hist(dat3$surT, breaks = 20)
```


#### Scenario 4
```{r}
set.seed(1)
n <- 50
b <- c(1, 3, 2)
X <- rmvnorm(n, sigma = matrix(c(1, 0.9, 0.9, 1), ncol = 2, nrow = 2))
dat4 <- sim_dat(b, X)
```

```{r}
hist(dat4$surT, breaks = 20)
```

```{r}
sim_dat_simple <- list(dat1, dat2, dat3, dat4)
saveRDS(sim_dat_simple, "./data/sim_dat_simple.rds")
```

